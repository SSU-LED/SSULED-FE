name: Deploy Frontend to EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          echo "${{ secrets.FRONTEND_ENV }}" > .env.production

          # Vite ë¹Œë“œ
          npm run build

          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo "Checking build output..."
          ls -la
          if [ -d "dist" ]; then
            echo "âœ… dist directory found"
            ls -la dist
          else
            echo "âŒ dist directory not found"
            echo "Available directories:"
            find . -maxdepth 2 -type d
            exit 1
          fi

      - name: Prepare deployment files
        run: |
          mkdir -p deploy

          # Vite ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
          echo "Copying dist directory..."
          cp -r dist deploy/

          # í•„ìˆ˜ íŒŒì¼ë“¤ ë³µì‚¬
          cp package.json deploy/
          cp package-lock.json deploy/

          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë³µì‚¬
          cp .env.production deploy/

          # ë°°í¬ ë‚´ìš© í™•ì¸
          echo "Deployment package contents:"
          ls -la deploy/

          # ì••ì¶•
          tar -czf deploy.tar.gz deploy

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "Host *
            ServerAliveInterval 60
            ServerAliveCountMax 30" > ~/.ssh/config
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Transfer files to EC2
        run: scp deploy.tar.gz ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USERNAME }}/

      - name: Deploy application
        run: |
          ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "
            set -e  # ì—ëŸ¬ ë°œìƒì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
            
            echo 'ğŸš€ Starting frontend deployment...'
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /home/${{ secrets.EC2_USERNAME }}/apps/frontend
            
            # ì••ì¶• í•´ì œ
            tar -xzf deploy.tar.gz
            
            # ê¸°ì¡´ íŒŒì¼ ë°±ì—… (ë¡¤ë°±ìš©)
            if [ -d '/home/${{ secrets.EC2_USERNAME }}/apps/frontend/dist' ]; then
              mv /home/${{ secrets.EC2_USERNAME }}/apps/frontend/dist /home/${{ secrets.EC2_USERNAME }}/apps/frontend/dist.backup.\$(date +%Y%m%d_%H%M%S) || true
            fi
            
            # íŒŒì¼ ë³µì‚¬
            cp -r deploy/dist /home/${{ secrets.EC2_USERNAME }}/apps/frontend/
            cp -f deploy/package.json /home/${{ secrets.EC2_USERNAME }}/apps/frontend/
            cp -f deploy/package-lock.json /home/${{ secrets.EC2_USERNAME }}/apps/frontend/
            cp -f deploy/.env.production /home/${{ secrets.EC2_USERNAME }}/apps/frontend/
            
            # ë””ë ‰í† ë¦¬ ì´ë™
            cd /home/${{ secrets.EC2_USERNAME }}/apps/frontend
            
            # serve íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸
            echo 'ğŸ“¦ Installing serve globally...'
            npm install -g serve
            
            # serve ì„¤ì¹˜ í™•ì¸
            which serve || (echo 'âŒ serve not found' && exit 1)
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo 'ğŸ›‘ Stopping existing frontend process...'
            pm2 stop ssuled-client || true
            pm2 delete ssuled-client || true
            
            # í¬íŠ¸ ì‚¬ìš© í™•ì¸ ë° ì •ë¦¬
            echo 'ğŸ” Checking port 3000...'
            lsof -ti :3000 | xargs -r kill -9 || true
            sleep 2
            
            # PM2 ecosystem íŒŒì¼ ìƒì„± (í•œ ì¤„ë¡œ ì‘ì„±)
            echo 'module.exports = {apps: [{name: \"ssuled-client\", script: \"serve\", args: [\"-s\", \"dist\", \"-l\", \"3000\"], cwd: \"/home/${{ secrets.EC2_USERNAME }}/apps/frontend\", instances: 1, autorestart: true, watch: false, max_memory_restart: \"200M\", env: {PORT: 3000}, error_file: \"./logs/client-err.log\", out_file: \"./logs/client-out.log\", log_file: \"./logs/client-combined.log\", time: true}]};' > ecosystem.config.js
            
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p logs
            
            echo 'ğŸš€ Starting new frontend process with ecosystem...'
            pm2 start ecosystem.config.js
            
            # í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ëŒ€ê¸°
            sleep 5
            
            # í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸
            echo 'ğŸ” Checking process status...'
            pm2 list | grep ssuled-client
            
            # í”„ë¡œì„¸ìŠ¤ê°€ online ìƒíƒœì¸ì§€ í™•ì¸
            if pm2 show ssuled-client | grep -q 'online'; then
              echo 'âœ… Frontend process is online'
            else
              echo 'âŒ Frontend process failed to start'
              echo 'PM2 status:'
              pm2 list
              echo 'PM2 logs:'
              pm2 logs ssuled-client --lines 20
              exit 1
            fi
            
            # í¬íŠ¸ í™•ì¸
            if netstat -tlnp | grep :3000; then
              echo 'âœ… Port 3000 is listening'
            else
              echo 'âŒ Port 3000 is not listening'
              exit 1
            fi
            
            # ë¡œì»¬ HTTP í…ŒìŠ¤íŠ¸
            echo 'ğŸŒ Testing local HTTP response...'
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo 'âœ… Local HTTP test passed'
            else
              echo 'âŒ Local HTTP test failed'
              curl -I http://localhost:3000 || true
              exit 1
            fi
            
            # PM2 ì„¤ì • ì €ì¥
            pm2 save
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -rf /home/${{ secrets.EC2_USERNAME }}/deploy
            rm /home/${{ secrets.EC2_USERNAME }}/deploy.tar.gz
            
            # ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (7ì¼ ì´ìƒëœ ê²ƒë“¤)
            find /home/${{ secrets.EC2_USERNAME }}/apps/frontend -name 'dist.backup.*' -mtime +7 -exec rm -rf {} + || true
            
            echo 'ğŸ‰ Frontend deployment completed successfully!'
          "

      - name: Verify deployment
        run: |
          ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "
            echo 'ğŸ“Š Final Verification:'
            
            echo '1. PM2 Process Status:'
            pm2 list
            
            echo '2. Frontend Application Info:'
            pm2 info ssuled-client
            
            echo '3. Port Status:'
            netstat -tlnp | grep :3000
            
            echo '4. Process Logs (last 10 lines):'
            pm2 logs ssuled-client --lines 10
            
            echo '5. HTTP Test:'
            curl -I http://localhost:3000
            
            echo 'âœ… Verification completed!'
            echo 'ğŸŒ Frontend should be available at: https://ounwan.site'
          "

      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "
            echo 'âŒ Deployment failed. Attempting rollback...'
            
            cd /home/${{ secrets.EC2_USERNAME }}/apps/frontend
            
            # ìµœì‹  ë°±ì—… ì°¾ê¸°
            LATEST_BACKUP=\$(ls -t dist.backup.* 2>/dev/null | head -n1)
            
            if [ ! -z \"\$LATEST_BACKUP\" ]; then
              echo \"Rolling back to: \$LATEST_BACKUP\"
              
              # í˜„ì¬ ì‹¤íŒ¨í•œ ë²„ì „ ì œê±°
              rm -rf dist
              
              # ë°±ì—…ìœ¼ë¡œ ë³µì›
              mv \"\$LATEST_BACKUP\" dist
              
              # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
              pm2 restart ssuled-client
              
              echo 'âœ… Rollback completed'
            else
              echo 'âš ï¸  No backup found for rollback'
            fi
          " || true
