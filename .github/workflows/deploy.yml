name: Deploy Frontend to EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          echo "${{ secrets.FRONTEND_ENV }}" > .env.production

          # Vite ë¹Œë“œ
          npm run build

      - name: Prepare deployment files
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp .env.production deploy/
          tar -czf deploy.tar.gz deploy

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "Host *
            ServerAliveInterval 60
            ServerAliveCountMax 30" > ~/.ssh/config
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Transfer files to EC2
        run: scp deploy.tar.gz ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USERNAME }}/

      - name: Deploy application
        run: |
          ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "
            set -e
            
            echo 'ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹œì‘...'
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /home/${{ secrets.EC2_USERNAME }}/apps/frontend
            
            # ì••ì¶• í•´ì œ
            tar -xzf deploy.tar.gz
            
            # ê¸°ì¡´ dist ë””ë ‰í† ë¦¬ ì‚­ì œ
            if [ -d '/home/${{ secrets.EC2_USERNAME }}/apps/frontend/dist' ]; then
              rm -rf /home/${{ secrets.EC2_USERNAME }}/apps/frontend/dist
            fi
            
            # íŒŒì¼ ë³µì‚¬
            cp -r deploy/dist /home/${{ secrets.EC2_USERNAME }}/apps/frontend/
            cp -f deploy/package.json /home/${{ secrets.EC2_USERNAME }}/apps/frontend/
            cp -f deploy/package-lock.json /home/${{ secrets.EC2_USERNAME }}/apps/frontend/
            cp -f deploy/.env.production /home/${{ secrets.EC2_USERNAME }}/apps/frontend/
            
            # ë””ë ‰í† ë¦¬ ì´ë™
            cd /home/${{ secrets.EC2_USERNAME }}/apps/frontend
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo 'ğŸ›‘ ê¸°ì¡´ í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ...'
            pm2 stop ssuled-client || true
            pm2 delete ssuled-client || true
            
            # í¬íŠ¸ ì •ë¦¬
            sudo lsof -ti :3000 | xargs -r sudo kill -9 || true
            sleep 2
            
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p logs
            
            echo 'ğŸš€ PM2ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘...'
            pm2 start serve --name ssuled-client -- -s dist -l 3000
            
            # PM2 ì„¤ì • ì €ì¥
            pm2 save
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -rf /home/${{ secrets.EC2_USERNAME }}/deploy
            rm /home/${{ secrets.EC2_USERNAME }}/deploy.tar.gz
            
            echo 'ğŸ‰ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ!'
          "
